from __future__ import annotations

from dataclasses import dataclass
from random import Random
from typing import Dict, List, Literal, Optional, Union


SkinType = Literal["dry", "oily", "normal", "combination", "sensitive"]

SKIN_TYPES: List[Dict[str, str]] = [
    {"value": "dry", "label": "乾燥肌"},
    {"value": "oily", "label": "脂性肌"},
    {"value": "normal", "label": "普通肌"},
    {"value": "combination", "label": "混合肌"},
    {"value": "sensitive", "label": "敏感肌"},
]


# ------------------------------------------------------------
# CARE_HINT_POOLS
# - "base": その肌タイプで事故りにくい「基本姿勢」(短文)
# - "quick": 具体的な時短アクション（AIがそのまま文章化しやすい）
# ※ ここは “医療” ではなく “生活の工夫” に寄せる
# ------------------------------------------------------------
CARE_HINT_POOLS: Dict[str, Dict[str, List[str]]] = {
    "dry": {
        "base": [
            "触る回数を減らし、こすらず押さえるようになじませる",
            "洗顔後は間を空けずに保湿へつなげる",
        ],
        "quick": [
            "洗顔後は肌が乾く前に（←ここがポイント）、化粧水で水分を入れてからクリームでフタをして終える",
            "時間がない日の保湿は、オールインワンだけに絞ってもいいので、それを手のひらで温め、こすらず押さえて水分を閉じ込める",
            "保湿する時、頬や口元など乾きやすい部分だけ重ねて、他は薄く仕上げて水分の偏りを防ぐ",
            "お風呂上がりはタオルで押さえて水気を取り、間を空けずに（←ここがポイント）保湿まで一気に済ませる",
            "乾燥が気になる日は、ドライヤーしている間にシートマスクでパックするなど、隙間時間のながらケアをプラスする",
            "寝ている間、枕に清潔なタオルを敷いて、肌への摩擦による刺激を抑える",
        ],
    },
    "oily": {
        "base": [
            "落としすぎず、うるおいは残して皮脂は“整える”イメージで続ける",
            "ベタつく部分ほど塗りすぎない（油分は必要最低限にする）",
            "日中は“こすらず押さえる”だけでリセットする",
        ],
        "quick": [
            "朝は洗顔で皮脂をサッと落としてから、化粧水の後の乳液は薄く1回で終える",
            "時間がない日は、洗顔後、化粧水のあとにオールインワンを薄く広げて完了（塗りすぎない）",
            "スキンケアの最後に、収れん系の化粧水をコットンで軽く押さえるだけにする（摩擦を防ぐため強くパッティングしない）",
            "日中のテカリはティッシュで“押さえるだけ”にして、こすらず整える（落としすぎと摩擦は避ける）",
            "帰宅後に一度洗顔して、化粧水＋ジェルや乳液を薄く1回、塗りすぎない方が皮脂が出にくい",
            "保湿するときは、Tゾーンは少なめ、乾きやすい部分だけ同じアイテムを少量足してバランスを取る",
            "ベタつきが気になる日の保湿は、さっぱり化粧水＋ジェル系を薄く1回にして終える",
            "毛穴が気になる日は、ビタミンC系のアイテムを“いつもの1ステップに置き換えるだけ”で取り入れる（増やしすぎない）",
        ],
    },
    "normal": {
        "base": [
            "今のバランスを崩さないことを優先する",
            "調子が良い日は増やさず、シンプルに整える",
        ],
        "quick": [
            "朝、時短スキンケアにしたい日は、泡で出てくるタイプや泡立て不要の洗顔料+UV効果のあるオールインワン保湿で完了",
            "洗顔後のスキンケアをオールインワンに絞って、それを手のひらで温めてハンドプレスで密着、で楽ちん保湿完了",
            "ベタつきが気になる日は、クリームや乳液の量をいつもより少しだけ減らして、肌の様子を見る",
            "今日は日中乾燥したなと感じたら、お風呂上がりに髪を乾かしながらシートマスクでパックするなど、ながらケアをプラスする",
            "ちょっと余裕がある日は、保湿アイテムを塗る前に手のひらで温めて、ハンドプレスで30秒だけ密着させる",
            "朝、ちゃんと洗顔する時間がないときは、ぬるま湯洗顔＋拭き取り化粧水で優しく汚れを取り除く",
            "肌の調子が安定している日は、スキンケアの工程を増やさず“いつも通り”で終える",
            "メイク前は、保湿をしっかりしすぎず「しっとりしたら止める」を意識する",
            "日中エアコンで乾燥しそうな日は、朝の保湿をほんの少しだけ丁寧にしておく",
            "夜は疲れている日は、落とす→保湿だけで終えて、肌を休ませる",
            "紫外線を浴びた日は、夜のスキンケアは美白より保湿を優先する",
            "いつもと違う環境（旅行・外泊）では、新しいケアを足さず、持ってきた最低限で整える",
            "肌に違和感がない日は、角質ケアや特別な美容は無理に入れなくてOK",
            "季節の変わり目は、アイテムを変える前に量や塗り方で様子を見る",
            "調子がいい日ほど“やりたくなる”けど、増やさない選択が結果的に安定につながる",
        ],
    },
    "combination": {
        "base": [
            "ベタつく所と乾く所を分けて、量で調整する",
            "全体を同じやり方にしない（部分ごとに最適化）",
        ],
        "quick": [
            "保湿は頬や口元など乾きやすい部分から始め、Tゾーンは最後に薄くで止める",
            "保湿剤を全体に広げたあと、乾燥しやすい部分だけ少量足して、境目は触りすぎない",
            "保湿する時、Tゾーンは“足りなかったら足す”くらいにして、最初から重ねすぎない",
            "メイク落としは皮脂が多い部分から先に落として、乾きやすい所は短時間で終える",
            "スキンケアの最後に、マスクや枕が当たる頬だけ軽く手で押さえて、こすれで崩れないように密着させて終える",
        ],
    },
    "sensitive": {
        "base": [
            "新しいことを増やさず、刺激を避ける",
            "触る回数を減らして、摩擦を最小限にする",
        ],
        "quick": [
            "今日はいつも通りの洗顔料で洗う→保湿だけで終えて、これ以上触らない（刺激と摩擦を防ぐ）",
            "赤みやヒリつきがある日は、ケアを増やさず“ここで止める”を選ぶ",
            "洗顔の時、泡は転がすだけにして、洗顔時間を短くし、すすぎを丁寧になるべく短時間で終える",
            "洗顔後、タオルは当てて水分を取るだけにしてこすらない、乾く前に即保湿へ進む",
            "肌に違和感を感じた日は、これ以上足さずに止めるのが正解、いつもの保湿を薄く1回で止めて、悪化しそうなら皮膚科を受診も考える",
            "汚れが気になっても洗顔回数を増やさず、夜だけ丁寧に落とすことを優先する",
            "朝の洗顔は、刺激を感じる日はぬるま湯だけで済ませる",
            "スキンケア前に深呼吸して、急がず落ち着いて触ることを意識する",
            "肌が不安定な日は、スキンケアアイテムや工程を増やさず、いつもの流れで終える",
            "いつもより時間がない日は、化粧水や保湿の量を少なめにしてもよいので、いつもと“同じ流れ”だけを丁寧に守る",
            "外出から帰宅後すぐの洗顔は避け、少し落ち着いてから触るようにする",
            "赤みが出やすい日は、温度差のある場所を行き来しすぎないように意識する",
            "肌に触れる前に手を清潔にして、余計な刺激を持ち込まない",
            "「肌を評価しない日」を作って、見た目を気にしすぎないことも大切",
            "違和感が続く日は、記録だけ残してケアは最小限に留める",
        ],
    },
}

COMMON_CARE_HINTS: Dict[str, List[str]] = {
    "sleep": [
        "寝る前に照明を1段階だけ落として、体に“夜の合図”を送る",
        "ベッドや布団に入る前に、明日の予定を1行だけ書いて頭を区切る",
        "入浴後は白湯や常温の水を少し飲んで、体温が下がる流れを作る",
        "枕元に置く物を減らして、視界をシンプルにしてから横になる",
        "布団に入ったら、呼吸をゆっくり数えるだけに意識を向ける",
        "寝る前に部屋の暑さ・乾燥だけでも確認して整える",
        "寝始めだけでも、快適な温度になるよう調整する",
        "乾燥しやすい日は、寝る前に、喉や肌を守るために湿度を意識する",
        "寝る前は、暖色系の光に切り替えて、体を睡眠モードに切り替える。",
        "寝る直前ではなく、少し前にシャワーなどで体を温めてから布団に入る。",
        "入浴後は体を冷やさないようにして、そのまま休む流れを作る",
        "布団に入ったら、息を“長く吐く”ことだけに意識を向ける",
        "横になったら、お腹がふくらむ呼吸をまずは3回だけ、続けられそうなら更に数回繰り返す",
        "寝る前に肩をすくめてストンと落とす動きを2回だけする",
        "考え事が止まらなくて寝付けない時は、頭の中で“明日やること1つ”だけ決めて区切る",
    ],
    "stress": [
        "今の気持ちを1語だけ頭の中で言葉にしてから深呼吸する",
        "肩をすくめてストンと落とす動きを2〜3回だけする",
        "今日やらなくていいことを1つ決めて、手放す",
        "目を閉じて、足の裏に体重が乗っている感覚に意識を向ける",
        "一度席を立って、姿勢を変えてから作業に戻る",
        "視界に入るものを3つだけ見つけて、名前をつける",
        "首を左右にゆっくり倒して、呼吸と一緒に戻す",
        "今やっていることを心の中で1回だけ言い直す",
        "手をぎゅっと握ってからパッと開く動きを1回だけする",
        "時計を一度だけ見て、「ここまででOK」と区切る",
        "背筋を伸ばして、息を吐きながら力を抜く",
        "「今すぐ解決しなくていいこと」を1つ後回しにする",
        "今日できたことを、小さくても1つ思い出す",
        "完璧じゃなくていい、と心の中で1回だけ言う",
        "今日はここまで、と一度区切るイメージを持つ",
    ],
    "menstrual": [
        "今日は肌の調子を上げる日ではなく、安定させる日と考える",
        "角質ケアや攻めの美容はお休みして、守る方向に切り替える",
        "新しいスキンケアは足さず、いつもの流れを崩さない",
        "少しの違和感でも深追いせず、早めに切り上げる",
        "『何かしなきゃ』より『これ以上しない』を選ぶ",
        "今日は反応が出やすい日と割り切って、結果を急がない",
        "肌の変化を評価せず、淡々と同じケアを続ける",
        "鏡や写真を見すぎず、肌への意識過多を避ける",
        "外的刺激が多い日は、スキンケアを最小限にする判断をする",
        "ホルモンの影響と理解して、自己判断で焦らない",
        "今日は『効かせる』より『荒らさない』を優先する",
        "少し調子が悪くても、失敗ではなく周期の一部と捉える",
        "肌に意識を向けすぎないよう、他のことに注意を分散させる",
        "変化を出そうとせず、現状維持できれば十分と考える",
        "今日は“回復待ちの日”として、肌を見守る姿勢で過ごす",
    ],
    "climate": [
        "守るケアを最優先するのが大切。新しいアイテムを追加するより、いつものケアを継続するイメージ",
        "刺激になりやすい角質ケアやマッサージはお休みする",
        "スキンケアは『効かせる』より『崩さない』を意識する",
        "肌が疲れやすい日と捉え、触りすぎないことで刺激を避けるようにする",
        "肌が疲れていることを意識して、低刺激スキンケアを心がける",
        "この不調は環境要因が原因かもと割り切って、結果を急がない",
        "紫外線が強い日は、スキンケアだけでなく日傘や帽子などの対策も併用する",
        "外出から帰宅したら『一度リセットして整える』意識でケアする",
        "できるだけ室内外の温度差が大きくなりすぎないように調整することを意識して、肌の負担を増やさないようにする",
        "汗や皮脂が気になっても、こすらず押さえるイメージで、摩擦刺激を避ける",
        "乾燥時：保湿のタイミングを逃さないことを優先する（入浴や洗顔後は即保湿）",
        "今日は肌が環境に反応しやすい日と割り切って、攻めより守りのケアを意識する",
        "不調を感じてもスキンケアを増やさず、いつもの流れを守る",
        "エアコン乾燥対策：保湿は量を増やすより“乾く前に整える”ことを意識する",
    ],
}

CARE_HINT_PREFIX_MAP: Dict[str, str] = {
    "sleep": "睡眠の質を良くするのための工夫：",
    "stress": "ストレス緩和のためにすぐできる工夫：",
    "menstrual": "ホルモンの悪影響が肌に出やすい時は刺激を避けるため、",
    "skincare": "スキンケアの工夫にこんなのがあります。",
    "climate": "温湿度・UVの悪影響を肌が受けやすい時の考え方・工夫：、",
}


@dataclass(frozen=True)
class CareHintSelection:
    skin_type: str
    base_hint: Optional[str]
    quick_hint: str


def normalize_skin_type(skin_type: Optional[str]) -> str:
    if not skin_type:
        return "normal"
    s = str(skin_type).strip().lower()
    return s if s in CARE_HINT_POOLS else "normal"


def pick_care_hints(
    skin_type: Optional[str],
    *,
    seed: Optional[int] = None,
    include_base: bool = False,
) -> CareHintSelection:
    """肌タイプに合わせたケアヒントを1つ選ぶ。

    - seed を渡すと、同じ user/date で同じ結果になりやすい（= 日次の再生成でもブレにくい）
    - include_base=True のときだけ base も1つ返す（基本は quick だけでOK）
    """
    st = normalize_skin_type(skin_type)
    pool = CARE_HINT_POOLS[st]

    rng = Random(seed)
    quick_hint = rng.choice(pool["quick"])

    base_hint: Optional[str] = None
    if include_base and pool.get("base"):
        base_hint = rng.choice(pool["base"])

    return CareHintSelection(
        skin_type=st,
        base_hint=base_hint,
        quick_hint=quick_hint,
    )


def pick_care_hint_by_focus(
    focus: Optional[str],
    *,
    skin_type: Optional[str] = None,
    seed: Optional[int] = None,
    include_reason: bool = False,
) -> str:
    """要注意の軸に合わせてケアヒントを1つ選ぶ。

    focus:
      - "sleep" / "stress" / "menstrual" は共通ヒント
      - "skincare" は肌タイプ別ヒント
      - None は肌タイプ別の既存ロジックにフォールバック
    """
    rng = Random(seed)
    if focus in COMMON_CARE_HINTS:
        hint = rng.choice(COMMON_CARE_HINTS[focus])
        return _add_reason_clause(hint, focus=focus) if include_reason else hint

    if focus == "skincare":
        hint = pick_care_hints(skin_type, seed=seed, include_base=False).quick_hint
        return _add_reason_clause(hint, focus=focus) if include_reason else hint

    hint = pick_care_hints(skin_type, seed=seed, include_base=False).quick_hint
    return _add_reason_clause(hint, focus=focus) if include_reason else hint


def _add_reason_clause(hint: str, *, focus: Optional[str]) -> str:
    prefix = CARE_HINT_PREFIX_MAP.get(focus)
    if not prefix:
        return hint
    return f"{prefix}{hint}"


def build_care_hint_context_text(
    selection_or_skin_type: Union[CareHintSelection, Optional[str]],
    *,
    seed: Optional[int] = None,
    include_base: bool = False,
) -> str:
    """LLMへ渡す短文コンテキスト。

    advice 側で「そのまま1文コピー」を強制しやすいように、ここは原則 “行動1文” だけを返す。

    呼び出し側の都合に合わせて2通りを許可します。
    1) CareHintSelection を渡す（推奨）
    2) skin_type(str) を渡す（後方互換）→内部で pick_care_hints して Selection を作る
    """
    if isinstance(selection_or_skin_type, CareHintSelection):
        sel = selection_or_skin_type
    else:
        sel = pick_care_hints(
            selection_or_skin_type,
            seed=seed,
            include_base=include_base,
        )

    # NOTE:
    # - advice 側で「そのまま1文コピー」を強制しやすいように、ここは原則 “行動1文” だけを返す。
    # - include_base=True のときのみ、2行目に方針を添える（LLMにコピペさせたい場合は include_base を使わない）。
    if not include_base or not sel.base_hint:
        return sel.quick_hint

    return "\n".join(
        [
            sel.quick_hint,
            f"（方針: {sel.base_hint}）",
        ]
    )
